<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Zero Hour: Configuration Helper</title>
    <script src="js/js-yaml.min.js"></script>
    <script src="js/tabulator.min.js"></script>
    <link href="css/tabulator_site.min.css" rel="stylesheet"/>
    <style>
      .tabulator-cell {
        text-align: center;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>Zero Hour Helper</h2>
    <p>Double click a row to check it. Refresh page to reset all.</p>
    <div class="buttons">
      <button id="history-undo" onclick='table.undo(); table.setGroupBy("checked");'>Undo</button>
      <button id="reset" onclick='location.reload();'>Refresh</button>
    </div>
    <div id="zero-table">
    </div>
    <script type="text/javascript">
      const CONFIGURATION = "voidConfiguration";
      const DATAURL = "https://vstone.github.io/zerohour-configuration-thingie/data.json";

      var consoleSorter = function(a, b, aRow, bRow, column, dir, sorterParams) {
        var aVals = a.split('-');
        var bVals = b.split('-');
        if (aVals[0] == bVals[0]) {
          return aVals[1] - bVals[1];
        }
        else {
          return aVals[0] - bVals[0];
        }
      }

      var colorMap = {
        cyan: "#bcf8ff",
        blue: "#82adff",
        purple: "#b293ff",
        red: "#ff8282",
        yellow: "#f8ff82",
        white: "#fff",
        green: "#82ff84",
      }

      var table = new Tabulator("#zero-table", {
        movableColumns: true,
        selectable: 1,
        history: true,
        groupBy: "checked",
        groupStartOpen: [function(value, count, data, group) {
          return !value;
        }],
        groupHeader: [
          function(value, count, data) {
            if (!value) { return "ToDo"; }
            else { return "Done"; }
          }
        ],
        columns: [
          { title: "Console 1", field: "console1", sorter: consoleSorter, },
          { title: "Console 2", field: "console2", sorter: consoleSorter, },
          { title: "Console 3", field: "console3", sorter: consoleSorter, },
          { title: "ColorTerm", field: "colorTerm",
            formatter:function(cell, formatterParams, onRendered) {
              cell.getElement().style.backgroundColor = colorMap[cell.getValue().split(" - ")[0]];
              return cell.getValue();
            }
          },
          {
            title: "Checked", field: "checked",
            formatter: "tickCross", formatterParams: {
              allowEmpty: false
            },
            editor: "tickCross", editorParams: {tristate:false, },
          }
        ],
        initialSort: [
          { column: "checked", dir: "asc" },
          { column: "console1", dir: "asc"},
        ],
        rowDblClick: function(e, row) {
          var checkCell = row.getCell("checked");
          var cellData = checkCell.getData();
          checkCell.setValue(!checkCell.getValue());
        },
        dataEdited: function(data) {
          table.setGroupBy("checked");
        },
        ajaxURL: DATAURL,
        ajaxResponse:function(url, params, response) {
          var data = response[CONFIGURATION];
          var output = [];
          Object.keys(data).forEach(function(color) {
            Object.keys(data[color]).forEach(function(colorId) {
              output.push({
                checked: false,
                color: color,
                colorId: colorId,
                colorTerm: color + " - " + colorId,
                console1: data[color][colorId][0],
                console2: data[color][colorId][1],
                console3: data[color][colorId][2]
              });
            });
          });
          return output;
        },
      });
    //undo button
    </script>
  </body>
</html>
