<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Zero Hour: Configuration Helper</title>
    <script src="js/js-yaml.min.js"></script>
    <script src="js/tabulator.min.js"></script>
    <link href="css/tabulator_site.min.css" rel="stylesheet"/>
    <style>
      .tabulator-cell {
        text-align: center;
        font-weight: bold;
      }
      .tabulator-cell[tabulator-field="colorTerm"] .left-color{
        display:inline-block;
        text-align:left;
        width:4em;
      }
      .tabulator-cell[tabulator-field="colorTerm"] .right-number{
        display:inline-block;
        text-align:right;
        width:1em;
      }
    </style>
  </head>
  <body>
    <h2>Zero Hour Helper: ARC (week 14th may)</h2>
    <p>Double click a row to check it. Checked records are moved to the bottom so you can deal with dupes more easily.<br/>
    Refresh page to reset all.</p>
    <div class="buttons">
      <button id="history-undo" onclick='table.undo(); table.setGroupBy("checked");'>Undo</button>
      <button id="reset" onclick='location.reload();'>Refresh</button>
    </div>
    <div id="zero-table">
    </div>
    <script type="text/javascript">
      const CONFIGURATION = "arcConfiguration";
      const DATAURL = "data.json";

      var consoleSorter = function(a, b, aRow, bRow, column, dir, sorterParams) {
        if (a == "x" && b == "x") {
          return 0;
        }
        else if (a == "x") {
          return -1;
        }
        else if (b == "x") {
          return 1;
        }

        var aVals = a.split('-');
        var bVals = b.split('-');
        if (aVals[0] == bVals[0]) {
          return aVals[1] - bVals[1];
        }
        else {
          return aVals[0] - bVals[0];
        }
      }

      var colorMap = {
        cyan: "#bcf8ff",
        blue: "#82adff",
        purple: "#b293ff",
        red: "#ff8282",
        yellow: "#f8ff82",
        white: "#fff",
        green: "#82ff84",
      }

      var colorCellFormatter = function(cell, formatterParams, onRendered) {
        let pair = cell.getValue().split(" - ");
        let color = pair[0];
        let number = pair[1];
        let color_html = "<div class='left-color'>"+color+"</div>";
        let number_html = "<div class='right-number'>"+number+"</div>";
        cell.getElement().style.backgroundColor = colorMap[color];
        // return cell.getValue();
        return color_html + number_html;
      };

      var table = new Tabulator("#zero-table", {
        movableColumns: true,
        selectable: 1,
        history: true,
        groupBy: "checked",
        groupStartOpen: [function(value, count, data, group) {
          return !value;
        }],
        groupHeader: [
          function(value, count, data) {
            if (!value) { return "ToDo"; }
            else { return "Done"; }
          }
        ],
        columns: [
          { title: "Console 1", field: "console1", sorter: consoleSorter, },
          { title: "Console 2", field: "console2", sorter: consoleSorter, },
          { title: "Console 3", field: "console3", sorter: consoleSorter, },
          { title: "ColorTerm", field: "colorTerm", formatter:colorCellFormatter},
          {
            title: "Checked", field: "checked",
            formatter: "tickCross", formatterParams: {
              allowEmpty: false
            },
            editor: "tickCross", editorParams: {tristate:false, },
          }
        ],
        initialSort: [
          { column: "console1", dir: "asc", },
        ],
        rowDblClick: function(e, row) {
          var checkCell = row.getCell("checked");
          var cellData = checkCell.getData();
          checkCell.setValue(!checkCell.getValue());
        },
        dataEdited: function(data) {
          table.setGroupBy("checked");
        },
        ajaxURL: DATAURL,
        ajaxResponse:function(url, params, response) {
          var data = response[CONFIGURATION];
          var output = [];
          Object.keys(data).forEach(function(color) {
            Object.keys(data[color]).forEach(function(colorId) {
              output.push({
                checked: false,
                color: color,
                colorId: colorId,
                colorTerm: color + " - " + colorId,
                console1: data[color][colorId][0],
                console2: data[color][colorId][1],
                console3: data[color][colorId][2]
              });
            });
          });
          return output;
        },
      });
    //undo button
    </script>
    <div id="github-ribbon" style="position: absolute; top: 0px; right: 0px;">
   <a href="https://github.com/vStone/zerohour-configuration-thingie"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    </div>
  </body>
</html>
